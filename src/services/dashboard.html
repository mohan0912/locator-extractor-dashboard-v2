<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Locator Extractor Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="container">
    <h2>Locator Extractor</h2>

    <label>Application URL:</label>
    <input id="url" type="text" placeholder="https://enterprise.company.com/home" />

    <label>Tag / Attribute Filter:</label>
    <input id="tagFilter" type="text" placeholder="button,input,a,[data-test-id]" />

    <label>Automation Framework:</label>
    <select id="automationFramework">
      <option value="playwright">Playwright</option>
      <option value="selenium">Selenium</option>
      <option value="cypress">Cypress</option>
      <option value="robot">Robot Framework</option>
      <option value="custom">Custom Framework</option>
    </select>

    <div id="customExampleSection" style="display: none;">
      <label>Example Definition (for custom frameworks):</label>
      <textarea id="customExample" rows="3"
        placeholder='e.g. this.loginButton = page.locator("[data-test=login]");'></textarea>
      <small>Provide a sample of how your framework defines elements.</small>
    </div>

    <div class="toggles">
      <!-- <label class="toggle-inline"><input type="checkbox" id="scanHidden" /> Scan hidden elements</label> -->
      <label class="toggle-inline"><input type="checkbox" id="autoTab" /> Auto Extract All (Smart DOM Walker)</label>

      <div id="generatePromptsContainer" style="display: none;">
        <label class="toggle-inline">
          <input type="checkbox" id="generatePrompts" />
          Generate AI Prompts (Auto Mode)
        </label>
      </div>
    </div>

    <div class="button-section">
      <button id="startBtn">Start Extraction</button>
      <button id="startAutoBtn" class="hidden">Start Auto Extraction</button>
      <button id="stopBtn" class="danger">Stop Extraction</button>
    </div>

    <pre id="log"></pre>
  </div>

  <script>
    let ws;
    let extractionRunning = false;

    const log = document.getElementById("log");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const startAutoBtn = document.getElementById("startAutoBtn");
    const autoTabCheckbox = document.getElementById("autoTab");
    const generatePromptsDiv = document.getElementById("generatePromptsContainer");
    const automationDropdown = document.getElementById("automationFramework");
    const customExampleSection = document.getElementById("customExampleSection");

    // Toggle additional options
    autoTabCheckbox.addEventListener("change", function () {
      if (this.checked) {
        generatePromptsDiv.style.display = "block";
        startAutoBtn.classList.remove("hidden");
      } else {
        generatePromptsDiv.style.display = "none";
        startAutoBtn.classList.add("hidden");
        document.getElementById("generatePrompts").checked = false;
      }
    });

    automationDropdown.addEventListener("change", () => {
      customExampleSection.style.display = automationDropdown.value === "custom" ? "block" : "none";
    });

    function addLog(message, level = "INFO") {
      const line = document.createElement("div");
      line.className = `log-line log-${level.toLowerCase()}`;
      line.textContent = `[${new Date().toLocaleTimeString()}] [${level}] ${message}`;
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    function updateButtonStates() {
      startBtn.disabled = extractionRunning;
      stopBtn.disabled = !extractionRunning;
      startAutoBtn.disabled = !extractionRunning;
    }

    function initWebSocket() {
      ws = new WebSocket("ws://localhost:3000");

      ws.onopen = () => addLog("‚úÖ Connected to backend.", "SUCCESS");

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.type === "log") addLog(data.message, data.level || "INFO");
        if (data.type === "done") addLog(data.message, "SUCCESS");
        if (data.type === "error") addLog(`‚ùå ${data.message}`, "ERROR");
      };

      ws.onclose = () => addLog("‚ö†Ô∏è Connection closed.", "WARN");
    }

    // Start Extraction
    startBtn.addEventListener("click", () => {
      const payload = {
        type: "start",
        url: document.getElementById("url").value.trim(),
        tagFilter: document.getElementById("tagFilter").value.trim(),
        automationFramework: automationDropdown.value,
        customExample: document.getElementById("customExample").value.trim(),
        headless: false,
        //scanHidden: document.getElementById("scanHidden").checked || false,
        autoTab: autoTabCheckbox.checked,
        generatePrompts: document.getElementById("generatePrompts").checked,
        onlyLaunch: !autoTabCheckbox.checked
      };

      if (!payload.url) return addLog("‚ùó Please provide a valid URL.", "WARN");

      ws.send(JSON.stringify(payload));
      addLog(`üöÄ Browser launched for ${payload.url}`, "INFO");
      extractionRunning = true;
      updateButtonStates();
    });

    // Start Auto Extraction
    startAutoBtn.addEventListener("click", () => {
      if (!extractionRunning) return addLog("‚ö†Ô∏è Start extraction first.", "WARN");

      const payload = {
        type: "autoExtract",
        tagFilter: document.getElementById("tagFilter").value.trim(),
        automationFramework: automationDropdown.value,
        generatePrompts: document.getElementById("generatePrompts").checked,
        triggeredAutoExtract: true, // ‚úÖ flag that user clicked "Start Auto Extraction"
        // scanHidden: document.getElementById("scanHidden").checked || false
      };

      ws.send(JSON.stringify(payload));
      addLog("ü§ñ Auto extraction triggered for current page.", "INFO");
    });

    // Stop Extraction
    stopBtn.addEventListener("click", () => {
      if (!extractionRunning) return addLog("‚ÑπÔ∏è No extraction running.", "INFO");
      ws.send(JSON.stringify({ type: "stop" }));
      addLog("üõë Stop requested by user.", "WARN");
      extractionRunning = false;
      updateButtonStates();
    });

    initWebSocket();
    updateButtonStates();
  </script>
</body>

</html>